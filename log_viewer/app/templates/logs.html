<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HoneyBot Logs Viewer</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 min-h-screen">
    <nav class="bg-blue-600 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">
                <i class="fas fa-list-alt mr-2"></i>
                HoneyBot Logs Viewer
            </h1>
            <div class="flex space-x-4">
                <a href="/" class="hover:bg-blue-700 px-3 py-2 rounded transition">Dashboard</a>
                <a href="/logs" class="hover:bg-blue-700 px-3 py-2 rounded transition bg-blue-700">Logs</a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <!-- Filters -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h3 class="text-lg font-semibold mb-4 text-gray-800">
                <i class="fas fa-filter mr-2 text-blue-600"></i>
                Filters
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
                <!-- Log Level Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Level</label>
                    <select id="level-filter" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">All Levels</option>
                        <option value="DEBUG">Debug</option>
                        <option value="INFO">Info</option>
                        <option value="WARNING">Warning</option>
                        <option value="ERROR">Error</option>
                        <option value="CRITICAL">Critical</option>
                    </select>
                </div>

                <!-- Time Range -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Time Range</label>
                    <select id="hours-filter" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="1">Last Hour</option>
                        <option value="6">Last 6 Hours</option>
                        <option value="24" selected>Last 24 Hours</option>
                        <option value="72">Last 3 Days</option>
                        <option value="168">Last Week</option>
                    </select>
                </div>

                <!-- User ID Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">User ID</label>
                    <input type="number" id="user-filter" placeholder="Enter User ID" 
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                           min="1" max="999999">
                </div>

                <!-- Action Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Action</label>
                    <input type="text" id="action-filter" placeholder="Action name" 
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                           maxlength="100">
                </div>

                <!-- Search -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                    <input type="text" id="search-filter" placeholder="Search in logs" 
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                           maxlength="200">
                </div>
            </div>

            <div class="flex justify-between items-center mt-4">
                <button onclick="applyFilters()" 
                        class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition">
                    <i class="fas fa-search mr-2"></i>
                    Apply Filters
                </button>
                
                <button onclick="clearFilters()" 
                        class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition">
                    <i class="fas fa-times mr-2"></i>
                    Clear All
                </button>
            </div>
        </div>

        <!-- Logs Display -->
        <div class="bg-white rounded-lg shadow-md">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-list mr-2 text-green-600"></i>
                        Logs <span id="logs-count" class="text-sm text-gray-500">(Loading...)</span>
                    </h3>
                    
                    <div class="flex space-x-2">
                        <button onclick="refreshLogs()" 
                                class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 transition">
                            <i class="fas fa-sync-alt mr-1"></i>
                            Refresh
                        </button>
                        
                        <button onclick="toggleAutoRefresh()" id="auto-refresh-btn"
                                class="bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700 transition">
                            <i class="fas fa-play mr-1"></i>
                            Auto Refresh
                        </button>
                    </div>
                </div>
            </div>

            <div id="logs-container" class="max-h-96 overflow-y-auto">
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>Loading logs...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Log Detail Modal -->
    <div id="log-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-6xl w-full max-h-screen overflow-y-auto">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-800">Log Details</h3>
                        <div class="flex space-x-2">
                            <button onclick="copyLogToClipboard()" class="text-blue-600 hover:text-blue-800">
                                <i class="fas fa-copy mr-1"></i>Copy JSON
                            </button>
                            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div id="log-modal-content" class="p-6">
                    <!-- Modal content will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let autoRefreshInterval = null;
        let currentFilters = {};
        let currentLogDetails = null;

        // Apply filters and load logs
        async function applyFilters() {
            const filters = {
                level: document.getElementById('level-filter').value,
                hours: parseInt(document.getElementById('hours-filter').value),
                user_id: document.getElementById('user-filter').value ? parseInt(document.getElementById('user-filter').value) : null,
                action: document.getElementById('action-filter').value,
                search: document.getElementById('search-filter').value,
                limit: 100  // Simple fixed limit
            };

            currentFilters = filters;
            await loadLogs(filters);
        }

        // Load logs function - simplified for simple API
        async function loadLogs(filters = {}) {
            try {
                const container = document.getElementById('logs-container');
                container.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fas fa-spinner fa-spin text-2xl mb-2"></i><p>Loading logs...</p></div>';

                const params = new URLSearchParams();
                Object.entries(filters).forEach(([key, value]) => {
                    if (value !== null && value !== '') {
                        params.append(key, value);
                    }
                });

                console.log('Fetching logs with params:', params.toString());
                const response = await fetch(`/api/logs?${params}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Received data:', data);

                // Update logs count - simple version
                document.getElementById('logs-count').textContent = `(${data.logs.length} logs)`;

                if (data.logs.length === 0) {
                    container.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fas fa-search text-2xl mb-2"></i><p>No logs found with current filters</p></div>';
                    return;
                }

                const logsHtml = data.logs.map(log => createLogEntry(log)).join('');
                container.innerHTML = logsHtml;

            } catch (error) {
                console.error('Failed to load logs:', error);
                document.getElementById('logs-container').innerHTML = 
                    `<div class="text-center py-8 text-red-500">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p>Failed to load logs: ${error.message}</p>
                        <button onclick="refreshLogs()" class="mt-2 bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">
                            <i class="fas fa-redo mr-1"></i>Retry
                        </button>
                    </div>`;
            }
        }

        // Create log entry HTML
        function createLogEntry(log) {
            const levelColors = {
                'DEBUG': 'bg-gray-100 text-gray-800 border-l-gray-400',
                'INFO': 'bg-blue-50 text-blue-900 border-l-blue-400',
                'WARNING': 'bg-yellow-50 text-yellow-900 border-l-yellow-400',
                'ERROR': 'bg-red-50 text-red-900 border-l-red-500',
                'CRITICAL': 'bg-purple-50 text-purple-900 border-l-purple-500'
            };

            const levelIcons = {
                'DEBUG': 'fas fa-bug',
                'INFO': 'fas fa-info-circle',
                'WARNING': 'fas fa-exclamation-triangle',
                'ERROR': 'fas fa-times-circle',
                'CRITICAL': 'fas fa-skull-crossbones'
            };

            const level = log.level || 'UNKNOWN';
            const colorClass = levelColors[level] || 'bg-gray-100 text-gray-800 border-l-gray-400';
            const iconClass = levelIcons[level] || 'fas fa-question-circle';
            
            // Format timestamp
            let timestamp = 'Unknown time';
            try {
                timestamp = new Date(log.timestamp).toLocaleString('en-US', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
            } catch (e) {
                console.warn('Invalid timestamp:', log.timestamp);
            }

            // Safe field access
            const message = escapeHtml(log.message || 'No message');
            const functionName = escapeHtml(log.function || 'Unknown');
            const lineNumber = log.line || '?';
            const moduleName = escapeHtml(log.module || 'Unknown');
            const userId = log.user_id || 'N/A';
            const action = escapeHtml(log.action || 'N/A');
            const executionTime = log.execution_time ? `${log.execution_time}s` : 'N/A';

            // Store log data with unique ID to avoid JSON parsing issues
            const logId = `log_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            window.logData = window.logData || {};
            window.logData[logId] = log;

            return `
                <div class="border-l-4 ${colorClass} p-4 border-b border-gray-100 hover:bg-opacity-75 transition cursor-pointer" 
                     onclick="showLogDetails('${logId}')">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center mb-2">
                                <i class="${iconClass} mr-2"></i>
                                <span class="font-semibold text-sm">${level}</span>
                                <span class="mx-2">•</span>
                                <span class="text-sm">${timestamp}</span>
                                ${log.execution_time ? `<span class="mx-2">•</span><span class="text-sm">${executionTime}</span>` : ''}
                            </div>
                            
                            <p class="text-sm font-medium mb-1">${message}</p>
                            
                            <div class="text-xs opacity-75">
                                <span class="mr-4"><i class="fas fa-user mr-1"></i>User: ${userId}</span>
                                <span class="mr-4"><i class="fas fa-cog mr-1"></i>Action: ${action}</span>
                                <span class="mr-4"><i class="fas fa-code mr-1"></i>${functionName}:${lineNumber}</span>
                                <span><i class="fas fa-layer-group mr-1"></i>${moduleName}</span>
                            </div>
                        </div>
                        
                        <button class="text-gray-400 hover:text-gray-600 ml-4" onclick="event.stopPropagation(); showLogDetails('${logId}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        // Show log details modal - FIXED to use stored log data
        function showLogDetails(logId) {
            if (!window.logData || !window.logData[logId]) {
                console.error('Log data not found for ID:', logId);
                return;
            }

            const logData = window.logData[logId];
            currentLogDetails = logData;
            const modal = document.getElementById('log-modal');
            const content = document.getElementById('log-modal-content');
            
            // Format timestamp
            let formattedTimestamp = 'Invalid timestamp';
            try {
                formattedTimestamp = new Date(logData.timestamp).toLocaleString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    timeZoneName: 'short'
                });
            } catch (e) {
                console.warn('Invalid timestamp in log details:', logData.timestamp);
            }

            // Create detailed view
            content.innerHTML = `
                <div class="space-y-6">
                    <!-- Header Info -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg">
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-2">Basic Information</h4>
                            <div class="space-y-1 text-sm">
                                <div><strong>Level:</strong> <span class="px-2 py-1 rounded text-xs ${getLevelBadgeClass(logData.level)}">${logData.level || 'Unknown'}</span></div>
                                <div><strong>Timestamp:</strong> ${formattedTimestamp}</div>
                                <div><strong>User ID:</strong> ${logData.user_id || 'N/A'}</div>
                                <div><strong>Action:</strong> ${escapeHtml(logData.action || 'N/A')}</div>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-2">Source Information</h4>
                            <div class="space-y-1 text-sm">
                                <div><strong>Module:</strong> ${escapeHtml(logData.module || 'Unknown')}</div>
                                <div><strong>Function:</strong> ${escapeHtml(logData.function || 'Unknown')}</div>
                                <div><strong>Line:</strong> ${logData.line || 'Unknown'}</div>
                                <div><strong>Execution Time:</strong> ${logData.execution_time ? logData.execution_time + 's' : 'N/A'}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Message -->
                    <div>
                        <h4 class="font-semibold text-gray-800 mb-2">Message</h4>
                        <div class="p-3 bg-gray-50 rounded border text-sm whitespace-pre-wrap">
                            ${escapeHtml(logData.message || 'No message')}
                        </div>
                    </div>

                    <!-- Stack Trace (if available) -->
                    ${logData.stack_trace ? `
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-2">Stack Trace</h4>
                            <pre class="p-3 bg-red-50 border border-red-200 rounded text-xs overflow-x-auto whitespace-pre-wrap">${escapeHtml(logData.stack_trace)}</pre>
                        </div>
                    ` : ''}

                    <!-- Additional Context (if available) -->
                    ${logData.context ? `
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-2">Additional Context</h4>
                            <div class="p-3 bg-blue-50 border border-blue-200 rounded">
                                ${formatContextData(logData.context)}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Raw JSON -->
                    <div>
                        <h4 class="font-semibold text-gray-800 mb-2">Raw JSON</h4>
                        <pre id="raw-json" class="p-3 bg-gray-100 border rounded text-xs overflow-x-auto max-h-64 whitespace-pre-wrap">${escapeHtml(JSON.stringify(logData, null, 2))}</pre>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        // Helper function to format context data nicely
        function formatContextData(context) {
            if (!context) return 'No context data';
            
            let html = '<div class="space-y-2">';
            
            for (const [key, value] of Object.entries(context)) {
                const formattedKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                let formattedValue;
                
                if (typeof value === 'object' && value !== null) {
                    formattedValue = `<pre class="text-xs mt-1 p-2 bg-white rounded border">${escapeHtml(JSON.stringify(value, null, 2))}</pre>`;
                } else {
                    formattedValue = `<span class="font-mono text-sm">${escapeHtml(String(value))}</span>`;
                }
                
                html += `<div><strong class="text-sm">${formattedKey}:</strong> ${formattedValue}</div>`;
            }
            
            html += '</div>';
            return html;
        }

        function getLevelBadgeClass(level) {
            const classes = {
                'DEBUG': 'bg-gray-200 text-gray-800',
                'INFO': 'bg-blue-200 text-blue-800',
                'WARNING': 'bg-yellow-200 text-yellow-800',
                'ERROR': 'bg-red-200 text-red-800',
                'CRITICAL': 'bg-purple-200 text-purple-800'
            };
            return classes[level] || 'bg-gray-200 text-gray-800';
        }

        function copyLogToClipboard() {
            if (!currentLogDetails) return;
            
            const jsonText = JSON.stringify(currentLogDetails, null, 2);
            navigator.clipboard.writeText(jsonText).then(() => {
                // Show success feedback
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check mr-1"></i>Copied!';
                button.className = 'text-green-600';
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.className = 'text-blue-600 hover:text-blue-800';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy to clipboard');
            });
        }

        function closeModal() {
            document.getElementById('log-modal').classList.add('hidden');
            currentLogDetails = null;
        }

        // Clear filters
        function clearFilters() {
            document.getElementById('level-filter').value = '';
            document.getElementById('hours-filter').value = '24';
            document.getElementById('user-filter').value = '';
            document.getElementById('action-filter').value = '';
            document.getElementById('search-filter').value = '';
            
            applyFilters();
        }

        // Refresh logs
        function refreshLogs() {
            applyFilters();
        }

        // Auto-refresh toggle
        function toggleAutoRefresh() {
            const btn = document.getElementById('auto-refresh-btn');
            
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                btn.innerHTML = '<i class="fas fa-play mr-1"></i>Auto Refresh';
                btn.className = 'bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700 transition';
            } else {
                autoRefreshInterval = setInterval(refreshLogs, 10000);
                btn.innerHTML = '<i class="fas fa-stop mr-1"></i>Stop Auto';
                btn.className = 'bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700 transition';
            }
        }

        // Escape HTML
        function escapeHtml(text) {
            if (typeof text !== 'string') {
                text = String(text);
            }
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Modal click handling
        document.getElementById('log-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Keyboard support
        document.addEventListener('keydown', function(e) {
            if (!document.getElementById('log-modal').classList.contains('hidden')) {
                if (e.key === 'Escape') {
                    closeModal();
                }
            }
        });

        // Enter key support for filters
        ['user-filter', 'action-filter', 'search-filter'].forEach(id => {
            document.getElementById(id).addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    applyFilters();
                }
            });
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            applyFilters();
        });
    </script>
</body>
</html>