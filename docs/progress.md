Дата: 2025-09-25
Ветка: master

Задачи:
- [х] скопировать проект cofe_bot в новую папку;
- [x] настроить docker-compose.yml//Entrypoint//Dockerfile;
- [x] порт БД 5335, порт для логгера 8880;
- [х] файлы логгера вручную скопировать с EasyBot;
- [х] поднять контейнеры и запустить копию проекта;
- [] актуализировать название отношений в БД, досоздать недостающие;
- [] выполнить миграции, заполнить справочники;

Что сделано:
- скопировал файлы с гита;
- очистил .git
- создал папку /docs в корне, загрузил презентацию, инициировал progress.md
- файлы логгера вручную перенес с тестового контура квартирного бота
- создал папку db в корне, перенес файлы, необъодимые для инициации расширения PostGIS в БД при запуске
- скопировал файлы для геокодинга
- контейнер поднялся, БД отвечает

Проблемы / блокеры:
- вроде бы все хорошо прошло

Дата: 2025-09-26
Ветка: master

Задачи:

- [x] актуализировать название отношений в БД, досоздать недостающие;
- [] выполнить миграции, заполнить справочники;

Что сделано:
- актуализировал названия отношений
- залил первую миграцию


Проблемы/блокеры
- при копировании файлов потерялись скрипты /alembic/scripts.py.mako и bot/alembic.ini
- переименовывание сущностей в БД это боль! Это потом еще скрипты ковырять. Нужно универсальное БД!

Дата: 2025-09-27
Ветка: master

Задачи:

- [x] актуализировать название отношений в БД, досоздать недостающие;
- [x] выполнить миграции;
- [x] заполнить справочники;
- [x] скорректировать код в сценариях под новые таблицы

Что сделано:
- актуализировал названия отношений;
- выполнил первую сгенерированную миграцию;
- создал и внес геометрию зон;
- заполнил справочники;
- скорректировал импорты.


Проблемы/блокеры
- осталось писать сценарии для медового бота

Дата: 2025-09-29
Ветвь: master

Задачи:
[x] описать процесс регистрации 
[x] добавить кнопку Посмотреть на карте

Сделано:
- сценарий регистрации создан. Особенности: все действия покупателя будут вынесены в отдельный хэндлер и самое главное - создание записи в session тоже будет там происходить.
- кнопка Показа на карте работает!
- добавил KrasPolHoney_bot в группу, чтобы он слал отчеты от работе БД и в группу EasySochi_admin для обращеений!!! Очень важно не забывать давать боту права администратора в определенные группы!
- выполнил миграцию, поменял тип данных колонки sizes.name на numeric
- построил сценарий добавления меда, отказался от идеи хранить фото каждого варианта размера в таблице
- скорректированы сценарии подтверждения и отказа от сохранения меда;
- идея с изоляцией главного меню заработала. В итоге пришлось точку старта настроить так, что можно входить в нее откуда угодно по tg_user_id. Для этого пришлось отдельно в main.py импортировать route_after_login и отдельно регистрировать в группу 0, но не факт, что это обязательно, там ошибка еще была из-за обработчика сообщений на старте.
- очень хорошо работает логирование, помогает 100%!!

Задачи на завтра:
[] - В блоке менеджера сделать просмотр всех товаров
[] - просмотр всей статистики
[] - написать автоотправку статистики из ботов в ТГ
[] - написать бота для рассылки сообщений

Дата: 2025-10-01
Ветвь: master

Задачи:
[x] - реализовать запись на дегустацию


Что сделано:
- реализована запись на дегустацию. Пока что просто создается запись в sessions со значением role_id = 3 (запись на дегустацию) В дальнейшем, будем рассылка по tg_user_id с приглашением и возможно с кнопкой Приду и Отклонить. 
- реализована проверка, что у пользователя есть запись в sessions с role_id = 3, sent_message = false (то есть он записался, но еще не получал приuлаiения). Если проверка = True, то новая запись не создается, а пользователь информируется, чтобы ждал.
- поиск меда при покупке реализован на 50%. При нажатии на выбор размера ошибка получается.



Проблемы:
- по поводу доставки есть сомнения. Те по идее я могу показать в карточке заказа две кнопки 
Купить с доставкой и Самовывоз. Но чтобы на лету пересчитать стоимость с доставкой, даже с учетом наличия уже отрисованных зон, должен быть адрес доставки. Не понятно пока где его запрашивать.
и если запрашивать точку из ТГ (локацию), то надо ее конвертировать в адрес, подтверждат. 
Я думаю, на обновление отложить этот вопрос. Пока что хер с ним.
- какая-то странная херня при фильтрации меда по типу, переписал условие where is_(true)
- блок Сохранения карточки меда тоже чудил - апдейт is_draft = False не выполнялся, а последние две проверки сработал, хотя я вроде бы ничего не менял.

Дата: 2025-10-02
Ветвь: master

Задачи:
[х] - реализовать путь покупки меда
[] - доделать личный кабинет: показать заказы и товары


Что сделано:
- отменил таблицу product_size_packages, сделал связь с тарой через таблицу sizes, потому что связь жестко привязана к размеру.
- прикрутил функцию Оставить комментарий к заказу. Теперь если комментарий нет, то робот пказывает кнопку, если комментарий уже есть, то не показывает.
- получилось сценарий заказа реализовать, подтвердить/отклонить


Проблемы и сложности:
- Чтобы бот имел право отправить уведомление в группу, нужно
а) сделать его админом
б) дать право Manage_stories (отправка сообщений)
- я не могу добавить свой второй аккаунт в группу менеджеров, абсурд какой-то
- нужно как в кофейном сделать - при нажатии Подтвердить меняется кнопка на Готов к выдаче. При нажатии меняется статус и уведомление идет покупателю.

Дата: 2025-10-03
Ветвь: master

Задачи:
[х] - доделать путь покупки меда: подтверждение готовности и получение заказа
[] - доделать личный кабинет продавца: показать заказы и товары
[] - добить логирование, все логировать
[] - выложить код на Гит(?)

Что сделано:
- разобрался с логированием
- добил процесс покупки:
-- покупатель может оставить комментарий к заказу
-- выбрать количество банок меда, цена динамически пересчитывается
-- создать заказ - менеджер в чате получает сообщение, пауза нажатия на подтверждение заказа логируется
-- кнопка Подтвердить меняется на Готов к выдаче
-- Время до нажатия на Выдачу логируется
-- покупатель получает сообщение с кнопками Получаю сегодня/завтра/послезавтра
-- продавец получает уведомление
-- последнее нажатие продавца фиксирует статус покупки - Оплачено.


Проблемы и сложности:
- нельзя положить в JSON время, надо приводить к строке через isoformat()

Дата: 2025-10-05
Ветвь: master

Задачи:
[] - доделать меню менеджера (заказы, товары)
[] - реализовать блок приглашения на дегустацию
[] - залить код на ГитХаб

Что сделано:
- показ статистики при входе менеджера. Если входит Овнер, ему показывается вся статистика по продажам, если менеджер из списка, что продажи, где он products.created_by (не тестировалось)
- Активные заказы - все кроме статусов Отменено, Просрочено, Черновик
- Продажи меда - все активные заказы (не только выданные)
- Заказы все - вообще все заказы во всех статучах, чтобы видеть, сколько мы теряем заказов
- Заказы в работе - все активные заказы (в скобках - все заказы в статусе Создано, то есть. на которые продавец еще не отреагировал)


Дата: 2025-10-08
Ветвь: master

Задачи:
[] - добить блок показа Мои товары
[] - разобраться с фильтрами в заказах

Что сделано:
- исправил ошибку при выдаче статистики при входе
- при передаче чисел в коллбэк использовалось три разных паттерна: r, экранирование символа d \\ и просто без всего. Сделал везде через регулярки (pattern = r"xxxxxx")



Проблемы:
- При подсчете статистики вылезла ошибка:
unsupported operand type(s) for +: 'decimal.Decimal' and 'float'
Хотя позавчера такого не было. Ок, приведу все в Decimal
- при показе товаров выводить первые пять сообщений, а потом остальные по запросу. Для этого можно использовать данные из context.user_data["product_list"]. Наверное.

Дата: 2025-10-09
Ветвь: master

Задачи:
[x] - добить блок показа Мои товары
[] - разобраться с фильтрами в заказах
[x] - реализовать отправку приглашений на дегустацию

Что сделано:
- получилось вывести все товары продавца, кнопки Редактировать цену и Удалить работают. Сообщения не удалются, в целом бардак. Все что вывалилось, так и остается там висеть. Надо наверсти порядок
- блок отправки приглашений реализован. Пока что в конце пользователю предлагается написать в ТП Приду, если хочет прийти. В дальнейшем можно попробовать автоматизировать.
- порядок навелся в блоке показа товаров;


Проблеме:
- блок показа товаров и заказов работает нестабильно: то одно, то другое отваливается, может быть имеет смысл разделить на отдельные состояния. Думаю да, следует переписать на 3 отдельных обработчика, а то они хз в каких состояниях какие коллбэки ловят

Дата: 2025-10-10
Ветвь: master

Задачи:
[х] - разобраться с фильтрами в заказах
[] - разделить показ продуктов на разные ветки, чтобы состояния не путались (возможно в след обновлении)

Что сделано:
- фильтры работают, отмена заказа из просмотра работает корректно
- исправлено Просмотр карточек тз-под овнера - в .env стояла лишняя запятая
- я разобрался: в коде подтверждения есть место, где бот проверяет откуда пришло подтверждение,  и если пришло из ЛК менеджера, то логика иная, чем просто из диалога. И флаг from_orders_list, который отмечает источник, не был установлен. Теперь процесс работает норма, продавец уведомлен алертом. 
- при апдейте сессии после приглашения действительно не учитывался фильтр по Роли и Статусу отправки, исправлено
- заполнил блок Инфо
- в Дегустации сделал уведомление алертом
- добавил условие, что если нет заказов в Создано, чтобы показывал заказы В работе
- убрал ограничение "нот нулл" из users.username, провоцировало ошибки
- сделал проверку, что если поле telegram.firstname, то обязательн нужно написать имя
- добавил с статистику количество пользователей 
- в фильтре Дегустаторов role_id = 3 заменил на переменную DEGUSTATOR_ROLE


Проблеме:
- похоже что при показе заказов админский фильтр не срабатывает, и выводит не все, а только "свои" заказы
- кнопка Подтвердить из просмотра заказа кидает менеджеру ошибку Ошибка: не установлен ID заказа, хотя статус в БД меняется корректно и сообшение пользователю приходит корректно
- кнопка Готов к выдаче просто удаляет просмотр заказа и ничего не происходит, надо разбираться
- если в заказах нет заказов в стутусе В работе, то функция просто вернет, что нет заказов
- кнопка готово по-прежнему не работает, то сообщение отправляет, что все готово


Дата: 2025-10-10
Ветвь: master

Что сделано:
- создал репозиторий, запушил проект на Гит
- устранил ошибку в редактировании цены: из-зв того, что функция handle_manager_products была написана под вызов из коллбэка - при прямом вызове падала с ошибкой. Добавил условие.
- починил кнопку Готов к выдаче из карточки заказа. Проблема ьыла в том, что session.commit был вызван после return ConversationHandler.END и соответственно не выполнялся. Также исправил обновление флага from_orders, просто pop было не достаточно, сделал именно присвоение значения флаг = false


Дата: 2025-10-14
Ветвь: main

Задача:
Клод говорит, что все операции, связанные с движением по этапам, надо изолировать в отдельное состояние и заканчивать выходом, чтобы никто там не застревал. Также советует добавить прерывание состояния в обработчик хендлеров. Это вообще то, что я просил с самого начало, а мне городили там огороды целые


Что сделано:
- движение по этапам заказа В работе - Готово - Нажал Клиент - Выдано разбил на отдельные обработчики, зарегистрировал в main в группу 0
- номер телефона менеджера в сообщение клиенту стал тянуть из users, а не из .env
- при вызове заказов продавца добавил условие, что если нет активных заказов - показать весь архив
- развел личный кабинет менеджера по разным веткам: заказы - продукты - приглашение
- прогнал по основным процессам
- запушил обновление в репозиторий


Проблеме:
- вчера у двух человек был глюк: после регистрации бот зацикливался на фазе введения номера. Регистрация успешная, все ок, а после этого на любое нажатие бот реагирует, как будто он ждет нмоер телефона, а ему дают неизвестно что.
- бот как-будто застревает в состояниях и не ловит коллбэки. После перезапуска бота начинает снова ловить. Я думаю, что это важная глобальная проблема.
- вчера еще последний коммит не коммитился. Сегодня вроде коммитится. Короче, непредсказуемое поведение. Это очень плохо. И это в чем проблема не понятно. И не понятно, поможет ли переход на вебхук
- в редактировании заказов в цене есть проверка на кому принадлежит товар, а в удалении нет
- Приглашение на дегустацию надо персонализировать

Дата: 2025-10-15
Ветвь: main

Задача:
- Скопировать проект на локальный сервер

Что сделано:
- создал приватный репо на ГитХаб easysochi_honey_backup;
- обнулил git на проде и создал новый;
- SSH ключ уже существует на локальном сервере, поэтому просто подключил новый репозиторий к проекту;
- скопировал код в приватный репозиторий;
- на локальном сервере создал отдельный каталог easysochi_temp;
- поменял владельца папки с root на себя: sudo chown -R easysochi:easysochi ~/easysochi_temp
- подключился к ГитХаб: ssh -T git@github.com
- клонировал репозиторий. Склонировалось все кроме .env, добавил вручную
- также вручную создал файл для переноса данных с БД /db/tools/save_dump.py, акиуализировал данные для подклюючения;
- интересно. Те теперь чтобы скопировать данные нужно поднять контейнер с БД (или там оставить) с новым портом и пользователем, как-то короче чтобы одновременно были доступны обе базы
- выполнил миграции БД
- данные скопированы в БД
- ошибки в импорте затесались из-за того, что снес пару файлов. Все исправил и запустил бота на "локальном" сервере



Идеи для обновления:
[] - реализовать сценарий доставки
[] - если заказ висит в статусе Готово к выдаче а гость игнорит, то направлять еще запрос или аннулировать
[] - после покупки предлагать гостю промокод на следующую покупку
[] - цвета на дашборде привязаны к ключам словаря stats/ Неизвестно, что там за сортировка, надо разобраться и зафиксировать цвета
[] - получать гео "магазина" и телефон продавца динамически из его данных. Телефон понятно бот запрашивает и хранит в users, надо также хранить адрес магазина, точку.
[] - отличная идея, когда сообщение об ошибке выскакиевает в виде алерта, или вообще любое уведомление. Надо провести ревизию и переделать все уведомления, где возможно, на алерты
[] - приглашение на дегустацию надо персонализировать
[] - в ЛК надо показывать также заказы в статусе Клиент проинформирован с кнопкой Куплено
